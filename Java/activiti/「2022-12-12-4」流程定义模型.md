```text
流程定义模型
2022-12-12
Java > Activiti
```

# 流程定义创建

```java
String name = "请假流程模型";
String key = "leaveProcess";
String desc = "请输入描述信息……";
int version = 1;

// 1. 初始空的模型
Model model = repositoryService.newModel();
model.setName(name);
model.setKey(key);
model.setVersion(version);

// 封装模型json对象
ObjectNode objectNode = objectMapper.createObjectNode();
objectNode.put(ModelDataJsonConstants.MODEL_NAME, name);
objectNode.put(ModelDataJsonConstants.MODEL_REVISION, version);
objectNode.put(ModelDataJsonConstants.MODEL_DESCRIPTION, desc);
model.setMetaInfo(objectNode.toString());
// 保存初始化的模型基本信息数据
repositoryService.saveModel(model);

// 封装模型对象基础数据json串
// {"id":"canvas","resourceId":"canvas","stencilset":{"namespace":"http://b3mn.org/stencilset/bpmn2.0#"},"properties":{"process_id":"未定义"}}
ObjectNode editorNode = objectMapper.createObjectNode();
ObjectNode stencilSetNode = objectMapper.createObjectNode();
stencilSetNode.put("namespace", "http://b3mn.org/stencilset/bpmn2.0#");
editorNode.replace("stencilset", stencilSetNode);
// 标识key
ObjectNode propertiesNode = objectMapper.createObjectNode();
propertiesNode.put("process_id", key);
editorNode.replace("properties", propertiesNode);

repositoryService.addModelEditorSource(model.getId(), editorNode.toString().getBytes("utf-8"));
```

# 流程定义查询

![image-20221212202957065](https://picgo.kwcoder.club/202208/202212122029565.png)

# 流程定义删除

```java
    public void deleteModel() {
        String modelId = "";
        repositoryService.deleteModel(modelId);
    }
```

# 流程定义模型导出ZIP

```java
    @Autowired
    private RepositoryService repositoryService;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    public void exportZip() throws IOException {
        String modelId = "2a2af1ab-7a16-11ed-896a-dac721b1f71a";
        Model model = repositoryService.getModel(modelId);
        if (null != model) {
            byte[] bpmnJsonBytes = repositoryService.getModelEditorSource(modelId);
            byte[] xmlBytes = bpmnJson2XmlBytes(bpmnJsonBytes);
            if (null == xmlBytes) {
                System.out.println("模型数据为空，清闲设计流程定义模型再进行导出！");
            } else {
                // 压缩包文件名
                String zipName = model.getName() + "." + model.getKey() + ".zip";
                File file = new File("/Users/zhinushannan/Downloads/" + zipName);
                FileOutputStream fos = new FileOutputStream(file);
                // 实例化zip输出流
                ZipOutputStream zipos = new ZipOutputStream(fos);
                // 将xml添加到压缩包中（指定xml文件名：xxx.bpmn20.xml）
                zipos.putNextEntry(new ZipEntry(model.getName() + ".bpmn20.xml"));
                zipos.write(xmlBytes);

                // 3. 查询流程定义模型的图片字节码
                byte[] pngBytes = repositoryService.getModelEditorSourceExtra(modelId);
                if (null != pngBytes) {
                    zipos.putNextEntry(new ZipEntry(model.getName() + "." + model.getKey() + ".png"));
                    zipos.write(pngBytes);
                }

                // 4. 以压缩包的形式导出
                zipos.closeEntry();
                zipos.close();
                System.out.println("导出成功");
            }
        } else {
            System.out.println("模型不存在");
        }
    }

    private byte[] bpmnJson2XmlBytes(byte[] bpmnJsonBytes) throws IOException {
        if (null == bpmnJsonBytes) {
            return null;
        }
        // 1. JSON字节码转成 bpmnModel 对象
        JsonNode jsonNode = objectMapper.readTree(bpmnJsonBytes);
        BpmnModel bpmnModel = new BpmnJsonConverter().convertToBpmnModel(jsonNode);
        // 2. bpmnModel 对象转为 xml 字节码
        return new BpmnXMLConverter().convertToXML(bpmnModel);
    }

```

# 流程定义模型导出XML（略）